# KamaCache-Go: åˆ†å¸ƒå¼ç¼“å­˜æ¶æ„ä¸ä½¿ç”¨æŒ‡å— ğŸš€

## 1.0 æ¦‚è¿° ğŸŒŸ

**KamaCache-Go** æ˜¯ä¸€ä¸ª â€œå¼€ç®±å³ç”¨â€ çš„é«˜æ€§èƒ½ã€åˆ†å¸ƒå¼ Go å†…å­˜ç¼“å­˜åº“ã€‚å®ƒå°†å¤æ‚çš„åˆ†å¸ƒå¼é€»è¾‘ï¼ˆå¦‚èŠ‚ç‚¹å‘ç°ã€gRPCé€šä¿¡ã€ä¸€è‡´æ€§å“ˆå¸Œï¼‰å®Œå…¨å°è£…ï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€ä¸ªæå…¶ç®€æ´çš„ APIã€‚ä½ åªéœ€å‡ è¡Œä»£ç ï¼Œå°±èƒ½å°†ä½ çš„å•æœºåº”ç”¨ç¼“å­˜æ— ç¼å‡çº§ä¸ºå¼ºå¤§çš„åˆ†å¸ƒå¼ç¼“å­˜é›†ç¾¤ã€‚

**æ ¸å¿ƒç‰¹æ€§:**

*   **âš¡ æè‡´æ˜“ç”¨**: é«˜åº¦å°è£…çš„ APIï¼Œéšè—æ‰€æœ‰åˆ†å¸ƒå¼ç»†èŠ‚ã€‚
*   **ğŸŒ åˆ†å¸ƒå¼é›†ç¾¤**: é€šè¿‡ gRPC å®ç°äº†é«˜æ•ˆã€ä½å»¶è¿Ÿçš„å¯¹ç­‰èŠ‚ç‚¹ï¼ˆPeer-to-Peerï¼‰é€šä¿¡ã€‚
*   **âš–ï¸ æ™ºèƒ½è·¯ç”±**: å†…ç½®ä¸€è‡´æ€§å“ˆå¸Œï¼Œè‡ªåŠ¨å°†ç¼“å­˜æ•°æ®åˆ†å¸ƒåˆ°æœ€åˆé€‚çš„èŠ‚ç‚¹ã€‚
*   **ğŸ›¡ï¸ è‡ªåŠ¨å®¹é”™**: å•ä¸ªèŠ‚ç‚¹å®•æœºä¸ä¼šå½±å“æ•´ä¸ªé›†ç¾¤ï¼Œä»…éƒ¨åˆ†æ•°æ®éœ€è¦é‡æ–°åŠ è½½ã€‚
*   **ğŸ—‘ï¸ LRU æ·˜æ±°**: é‡‡ç”¨ LRU ç­–ç•¥è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œä¿æŒé«˜å‘½ä¸­ç‡ã€‚

## 2.0 æ¶æ„ä¸è°ƒç”¨æµç¨‹ ğŸ›ï¸

å°½ç®¡å®ç°ç»†èŠ‚è¢«å°è£…ï¼Œä½†ç†è§£å…¶é«˜å±‚å·¥ä½œåŸç†æœ‰åŠ©äºä½ æ›´å¥½åœ°ä½¿ç”¨å®ƒã€‚

### 2.1 ğŸ  å•å®ä¾‹æ¨¡å¼

å½“ä½ çš„åº”ç”¨åªå¯åŠ¨ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼ŒKamaCache-Go ä¼šè‡ªåŠ¨ä»¥å•å®ä¾‹æ¨¡å¼è¿è¡Œï¼Œæ‰€æœ‰æ“ä½œéƒ½åœ¨æœ¬åœ°å†…å­˜å®Œæˆï¼Œæ— ä»»ä½•ç½‘ç»œå¼€é”€ã€‚

**è°ƒç”¨æµç¨‹å›¾:**
```mermaid
graph TD
    A[ğŸ’» ä½ çš„åº”ç”¨] -- Get("my_key") --> B{ğŸ—ƒï¸ Cache Group};
    subgraph "KamaCache-Go å®ä¾‹"
        B -- 1. æŸ¥æœ¬åœ°ç¼“å­˜ --> C[ğŸ—‘ï¸ LRU Cache];
        C -- âœ… å‘½ä¸­ --> D[è¿”å›å€¼];
        C -- âŒ æœªå‘½ä¸­ --> E{2. è°ƒç”¨ Getter};
        E -- ä»æ•°æ®æºè·å– --> F[ğŸ—„ï¸ æ•°æ®åº“/API];
        F -- è¿”å›æ•°æ® --> E;
        E -- 3. å¡«å……ç¼“å­˜ --> C;
        E -- è¿”å›æ•°æ® --> D;
    end
    D --> A;
```

### 2.2 ğŸŒ åˆ†å¸ƒå¼é›†ç¾¤æ¨¡å¼

å½“ä½ å¯åŠ¨å¤šä¸ªé…ç½®äº†ç›¸åŒå¯¹ç­‰èŠ‚ç‚¹åˆ—è¡¨çš„å®ä¾‹æ—¶ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨ç»„æˆä¸€ä¸ªé›†ç¾¤ã€‚**æ‰€æœ‰å¤æ‚çš„ gRPC é€šä¿¡å’ŒèŠ‚ç‚¹æŸ¥æ‰¾éƒ½åœ¨åº“å†…éƒ¨è‡ªåŠ¨å®Œæˆ**ã€‚

#### **Get(key) è¯»å–æµç¨‹**

å¯¹ä½ çš„åº”ç”¨ä»£ç æ¥è¯´ï¼Œè°ƒç”¨æ–¹å¼ä¸å•å®ä¾‹æ¨¡å¼**å®Œå…¨ä¸€æ ·**ï¼Œä½†å…¶å†…éƒ¨çš„è°ƒç”¨æµç¨‹å´å¤§ä¸ç›¸åŒã€‚

1.  ä½ çš„åº”ç”¨åœ¨**èŠ‚ç‚¹A**ä¸Šè°ƒç”¨ `group.Get("some_key")`ã€‚
2.  KamaCache-Go **ä¼˜å…ˆæ£€æŸ¥èŠ‚ç‚¹Açš„æœ¬åœ°ç¼“å­˜**ã€‚å¦‚æœå‘½ä¸­ï¼Œç«‹å³è¿”å›ã€‚
3.  å¦‚æœæœ¬åœ°æœªå‘½ä¸­ï¼ŒKamaCache-Go ä¼š**è‡ªåŠ¨æŸ¥è¯¢å†…ç½®çš„ä¸€è‡´æ€§å“ˆå¸Œç¯**ã€‚
4.  **æƒ…å†µä¸€ï¼šå“ˆå¸Œç¯æŒ‡ç¤º `some_key` å°±åº”è¯¥å­˜æ”¾åœ¨èŠ‚ç‚¹A**ã€‚åº“ä¼šè‡ªåŠ¨è°ƒç”¨ä½ æä¾›çš„ `Getter` ä»æ•°æ®åº“åŠ è½½æ•°æ®ï¼Œå­˜å…¥èŠ‚ç‚¹Açš„æœ¬åœ°ç¼“å­˜åè¿”å›ã€‚
5.  **æƒ…å†µäºŒï¼šå“ˆå¸Œç¯æŒ‡ç¤º `some_key` å­˜æ”¾åœ¨è¿œç¨‹çš„èŠ‚ç‚¹B**ã€‚KamaCache-Go ä¼š**è‡ªåŠ¨å‘èŠ‚ç‚¹Bå‘èµ·ä¸€ä¸ªå†…éƒ¨çš„ gRPC è¯·æ±‚**ï¼Œè·å–æ•°æ®åè¿”å›ç»™ä½ çš„åº”ç”¨ã€‚

**è°ƒç”¨æµç¨‹å›¾:**
```mermaid
graph TD
    Client[ğŸ’» åº”ç”¨ @ èŠ‚ç‚¹A] -- Get(key) --> GA{ğŸ—ƒï¸ Group @ èŠ‚ç‚¹A}
  
    subgraph "KamaCache-Go åº“å†…éƒ¨ (å®Œå…¨è‡ªåŠ¨)"
        GA -- 1. ä¼˜å…ˆæŸ¥æœ¬åœ° --> CA[ğŸ—‘ï¸ LRU @ A]
        CA -- âœ… æœ¬åœ°å‘½ä¸­ --> Client
        CA -- âŒ æœ¬åœ°æœªå‘½ä¸­ --> Pick{2. å†…éƒ¨æŸ¥è¯¢<br>ä¸€è‡´æ€§å“ˆå¸Œç¯}
        Pick -- è´Ÿè´£äººæ˜¯è‡ªå·± --> Load(3a. å†…éƒ¨è°ƒç”¨ Getter<br>ä» DB åŠ è½½)
        Load -- è¿”å›å€¼ --> Client
        Pick -- è´Ÿè´£äººæ˜¯èŠ‚ç‚¹B --> gRPCClient(3b. å†…éƒ¨å‘èµ·<br>ğŸ“ gRPC è¯·æ±‚)
    end

    subgraph èŠ‚ç‚¹B
        gRPCServer[ğŸ“¡ å†…éƒ¨ gRPC æœåŠ¡ @ B]
    end

    gRPCClient --> gRPCServer
    gRPCServer --> gRPCClient
    gRPCClient -- è¿”å›å€¼ --> Client
```

#### **Set(key, value) å†™å…¥æµç¨‹**

ä¸è¯»å–æµç¨‹ä¸€æ ·ï¼Œ`Set` æ–¹æ³•ä¹Ÿä¼šè‡ªåŠ¨å°†æ•°æ®å†™å…¥æ­£ç¡®çš„èŠ‚ç‚¹ã€‚

1.  ä½ çš„åº”ç”¨åœ¨**èŠ‚ç‚¹A**ä¸Šè°ƒç”¨ `group.Set("some_key", "value")`ã€‚
2.  KamaCache-Go **è‡ªåŠ¨æŸ¥è¯¢ä¸€è‡´æ€§å“ˆå¸Œç¯**ï¼Œå®šä½åˆ°è´Ÿè´£ `some_key` çš„èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯èŠ‚ç‚¹Aè‡ªå·±ï¼Œä¹Ÿå¯èƒ½æ˜¯è¿œç¨‹çš„èŠ‚ç‚¹Bï¼‰ã€‚
3.  åº“**è‡ªåŠ¨å°†æ•°æ®**é€šè¿‡å†…å­˜å†™å…¥æˆ–å†…éƒ¨ gRPC è¯·æ±‚ï¼Œ**å­˜æ”¾åˆ°æ­£ç¡®çš„èŠ‚ç‚¹**ä¸Šã€‚

> âœ¨ **æ ¸å¿ƒä»·å€¼**: ä½ çš„ä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒæ•°æ®åˆ°åº•å­˜åœ¨å“ªä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿæ— éœ€æ‰‹åŠ¨ç¼–å†™ä»»ä½•ç½‘ç»œé€šä¿¡ä»£ç ã€‚åªéœ€åƒæ“ä½œä¸€ä¸ªæœ¬åœ° Map ä¸€æ ·æ“ä½œ `Group` å¯¹è±¡å³å¯ã€‚

## 3.0 å¿«é€Ÿå¼€å§‹æŒ‡å— ğŸš€

ä¸‹é¢æˆ‘ä»¬æ¥å®é™…æ“ä½œï¼Œæ­å»ºä¸€ä¸ªä¸‰èŠ‚ç‚¹çš„åˆ†å¸ƒå¼ç¼“å­˜é›†ç¾¤ã€‚

### **ç¬¬ 1 æ­¥: åˆå§‹åŒ–é¡¹ç›®å¹¶è·å–ä¾èµ–** âœ…

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir my-cluster-app
cd my-cluster-app

# åˆå§‹åŒ– Go Module
go mod init my-cluster-app

# è·å– KamaCache-Go åº“ (è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…åº“è·¯å¾„)
go get github.com/rson9/KamaCache-Go 
```

### **ç¬¬ 2 æ­¥: ç¼–å†™å¯åŠ¨ä»£ç  (`main.go`)** âœï¸

è¿™æ˜¯å”¯ä¸€éœ€è¦ä½ ç¼–å†™çš„æ–‡ä»¶ã€‚ä½ åªéœ€è¦åšä¸‰ä»¶äº‹ï¼š
1.  å®šä¹‰é›†ç¾¤ä¸­æœ‰å“ªäº›èŠ‚ç‚¹ã€‚
2.  åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªç¼“å­˜ç»„ (`Group`)ï¼Œå¹¶æä¾›æ•°æ®æºå›æºé€»è¾‘ (`Getter`)ã€‚
3.  è°ƒç”¨ KamaCache-Go çš„å¯åŠ¨å‡½æ•°ã€‚

```go
package main

import (
	"flag"
	"fmt"
	"log"
	"net/http"
	kamacache "github.com/rson9/KamaCache-Go" 
)

// 1. æ¨¡æ‹Ÿåç«¯æ•°æ®åº“
var db = map[string]string{
	"Tom":   "630",
	"Jack":  "589",
	"Sam":   "567",
	"Peter": "999",
}

func main() {
	// 2. å®šä¹‰å‘½ä»¤è¡Œå‚æ•°ï¼Œç”¨äºåŒºåˆ†ä¸åŒèŠ‚ç‚¹
	var port int
	var isApiServer bool
	flag.IntVar(&port, "port", 8001, "KamaCache node's communication port")
	flag.BoolVar(&api, "api", false, "Set to true to start a public API server on this node")
	flag.Parse()

	// 3. å®šä¹‰é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„åœ°å€
	//    åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™åº”è¯¥æ¥è‡ªé…ç½®ä¸­å¿ƒæˆ–æœåŠ¡å‘ç°
	peers := []string{
		"localhost:8001",
		"localhost:8002",
		"localhost:8003",
	}
	selfAddr := fmt.Sprintf("localhost:%d", port)

	// 4. åˆ›å»ºä¸€ä¸ªç¼“å­˜ç»„ (Group)
	scoresGroup := kamacache.NewGroup("scores", 2<<10, kamacache.GetterFunc(
		func(key string) ([]byte, error) {
			log.Printf("[SlowDB] Searching for key: %s", key)
			if val, ok := db[key]; ok {
				return []byte(val), nil
			}
			return nil, fmt.Errorf("key %s not found", key)
		},
	))

	// 5. å¦‚æœæ˜¯ API èŠ‚ç‚¹ï¼Œå¯åŠ¨ä¸€ä¸ªå¯¹å¤–çš„ HTTP æœåŠ¡æ–¹ä¾¿æµ‹è¯•
	if isApiServer {
		go startAPIServer("9999", scoresGroup)
	}

	// 6. âœ¨ å¯åŠ¨é›†ç¾¤èŠ‚ç‚¹ï¼âœ¨
	//    è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼ŒKamaCache-Go ä¼šåœ¨æ­¤å¤„å¯åŠ¨ gRPC æœåŠ¡å¹¶ç®¡ç†å¯¹ç­‰èŠ‚ç‚¹è¿æ¥ã€‚
	//    è¿™æ˜¯ä¸€ä¸ªé˜»å¡å‡½æ•°ï¼Œå®ƒä¼šä¸€ç›´è¿è¡Œã€‚
	log.Printf("KamaCache-Go node is running at %s", selfAddr)
	node, err := kamacache.NewNode(selfAddr, peers)
	if err != nil {
		log.Fatalf("Failed to create node: %v", err)
	}
	node.RegisterGroup(scoresGroup) // å°†æˆ‘ä»¬åˆ›å»ºçš„ group æ³¨å†Œåˆ°èŠ‚ç‚¹
	if err := node.Start(); err != nil {
		log.Fatalf("Failed to start node: %v", err)
	}
}

// startAPIServer æ˜¯ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨ï¼Œç”¨äºä»å¤–éƒ¨è®¿é—®ç¼“å­˜
func startAPIServer(apiAddr string, group *kamacache.Group) {
	http.HandleFunc("/api", func(w http.ResponseWriter, r *http.Request) {
		key := r.URL.Query().Get("key")
		view, err := group.Get(key)
		if err != nil {
			http.Error(w, err.Error(), http.StatusNotFound)
			return
		}
		w.Header().Set("Content-Type", "application/octet-stream")
		w.Write(view.ByteSlice())
	})
	log.Println("Public API server is running at", apiAddr)
	http.ListenAndServe(apiAddr, nil)
}
```
*(æ³¨: ä»¥ä¸Š `kamacache.NewNode`, `node.RegisterGroup`, `node.Start` æ˜¯åŸºäºä¼˜ç§€åº“è®¾è®¡æ¨¡å¼çš„æ¨æ–­ï¼Œè¯·æ ¹æ®ä½ çš„å®é™… API è¿›è¡Œè°ƒæ•´ã€‚)*

### **ç¬¬ 3 æ­¥: å¯åŠ¨å¹¶è¿è¡Œé›†ç¾¤** ğŸ’¨

æ‰“å¼€ **3ä¸ª** ç‹¬ç«‹çš„ç»ˆç«¯çª—å£ï¼Œåˆ†åˆ«å¯åŠ¨ä¸‰ä¸ªèŠ‚ç‚¹ã€‚æˆ‘ä»¬å°† Node 1 ä½œä¸ºå¯¹å¤–æä¾› API æœåŠ¡çš„å…¥å£ã€‚

*   **ç»ˆç«¯ 1 (API & èŠ‚ç‚¹1):**
    ```bash
    go run main.go --port=8001 --api=true
    ```
*   **ç»ˆç«¯ 2 (èŠ‚ç‚¹2):**
    ```bash
    go run main.go --port=8002
    ```
*   **ç»ˆç«¯ 3 (èŠ‚ç‚¹3):**
    ```bash
    go run main.go --port=8003
    ```

### **ç¬¬ 4 æ­¥: è§è¯å¥‡è¿¹** âœ¨

é›†ç¾¤å·²åœ¨è¿è¡Œï¼ç°åœ¨æ‰“å¼€**ç¬¬ 4 ä¸ªç»ˆç«¯**ï¼Œä½¿ç”¨ `curl` è¿›è¡Œæµ‹è¯•ï¼š

1.  **ç¬¬ä¸€æ¬¡è¯·æ±‚ `Tom`:**
    ```bash
    curl "http://localhost:9999/api?key=Tom"
    ```
  *   **ç°è±¡**: åœ¨æŸä¸ªèŠ‚ç‚¹çš„ç»ˆç«¯ï¼ˆå¦‚èŠ‚ç‚¹1ï¼‰ä¼šæ‰“å° `[SlowDB] Searching for key: Tom`ã€‚


2.  **å†æ¬¡è¯·æ±‚ `Tom`:**
    ```bash
    curl "http://localhost:9999/api?key=Tom"
    ```
  *   **ç°è±¡**: **æ‰€æœ‰èŠ‚ç‚¹**çš„ç»ˆç«¯éƒ½**æ²¡æœ‰ä»»ä½•æ—¥å¿—**ã€‚æ•°æ®å·²ä»ç¼“å­˜ä¸­å¿«é€Ÿè¿”å›ï¼


3.  **è¯·æ±‚ `Peter` (ä¸€ä¸ªå¯èƒ½åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šçš„é”®):**
    ```bash
    curl "http://localhost:9999/api?key=Peter"
    ```
  *   **ç°è±¡**: ä½ ä¼šçœ‹åˆ°**å¦ä¸€ä¸ªèŠ‚ç‚¹**ï¼ˆå¦‚èŠ‚ç‚¹2æˆ–3ï¼‰çš„ç»ˆç«¯æ‰“å°äº† `[SlowDB]` æ—¥å¿—ã€‚API æœåŠ¡ï¼ˆèŠ‚ç‚¹1ï¼‰é€šè¿‡å†…éƒ¨çš„ gRPC é€šä¿¡ï¼Œé€æ˜åœ°ä»è´Ÿè´£è¯¥é”®çš„èŠ‚ç‚¹è·å–äº†æ•°æ®ã€‚

ä½ æˆåŠŸäº†ï¼ä½ å·²ç»ç”¨ä¸€ä¸ªéå¸¸ç®€å•çš„ `main.go` æ–‡ä»¶ï¼Œå¯åŠ¨å¹¶éªŒè¯äº†ä¸€ä¸ªå…¨åŠŸèƒ½çš„åˆ†å¸ƒå¼ç¼“å­˜é›†ç¾¤ã€‚

## 4.0 éƒ¨ç½²ä¸æœ€ä½³å®è·µ ğŸ’¡

*   **å®¹å™¨åŒ–**: å¼ºçƒˆå»ºè®®ä½¿ç”¨ Docker å°†åº”ç”¨æ‰“åŒ…ï¼Œå¹¶é€šè¿‡ Kubernetes æˆ– Docker Compose è¿›è¡Œéƒ¨ç½²å’Œç®¡ç†ã€‚
*   **æœåŠ¡å‘ç°**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”é€šè¿‡é…ç½®ä¸­å¿ƒï¼ˆå¦‚ Nacos, Etcdï¼‰æˆ–K8sçš„æœåŠ¡å‘ç°æœºåˆ¶æ¥åŠ¨æ€ç®¡ç† `peers` åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç ã€‚
*   **ç½‘ç»œ**: å°†æ‰€æœ‰ç¼“å­˜èŠ‚ç‚¹éƒ¨ç½²åœ¨åŒä¸€ä¸ªä½å»¶è¿Ÿçš„å†…ç½‘ç¯å¢ƒï¼ˆå¦‚ AWS VPC æˆ–é˜¿é‡Œäº‘ VPCï¼‰ä¸­ï¼Œä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚
*   **ç›‘æ§**: ç›‘æ§èŠ‚ç‚¹çš„ CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠç¼“å­˜çš„å‘½ä¸­ç‡ã€Get/Set æ¬¡æ•°ç­‰å…³é”®æŒ‡æ ‡ã€‚